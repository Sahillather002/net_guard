from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime, timedelta
import uvicorn
import random
import os

app = FastAPI(title="NetGuard Firewall Service", version="2.0.0")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

class FirewallRule(BaseModel):
    id: str
    name: str
    source: str
    destination: str
    port: str
    protocol: str
    action: str
    status: str
    priority: int
    hits: int
    created_at: str
    updated_at: str

class CreateRuleRequest(BaseModel):
    name: str
    source: str
    destination: str
    port: str
    protocol: str
    action: str
    priority: Optional[int] = 100

# Sample firewall rules
def generate_rules(count=15):
    rules = []
    actions = ["allow", "deny"]
    protocols = ["TCP", "UDP", "ICMP", "Any"]
    statuses = ["enabled", "disabled"]
    
    for i in range(count):
        action = random.choice(actions)
        rules.append({
            "id": f"FW-{str(i+1).zfill(3)}",
            "name": f"Rule {i+1}: {action.title()} Traffic",
            "source": random.choice(["Any", "192.168.1.0/24", "10.0.0.0/8", "203.0.113.0/24"]),
            "destination": random.choice(["Any", "192.168.1.100", "10.0.0.50"]),
            "port": random.choice(["Any", "80", "443", "22", "3389", "8080"]),
            "protocol": random.choice(protocols),
            "action": action,
            "status": random.choice(statuses),
            "priority": random.randint(1, 1000),
            "hits": random.randint(0, 10000),
            "created_at": (datetime.now() - timedelta(days=random.randint(1, 365))).isoformat(),
            "updated_at": (datetime.now() - timedelta(hours=random.randint(1, 24))).isoformat()
        })
    return sorted(rules, key=lambda x: x["priority"])

SAMPLE_RULES = generate_rules()

@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "service": "firewall-service",
        "version": "2.0.0",
        "active_rules": len([r for r in SAMPLE_RULES if r["status"] == "enabled"])
    }

@app.get("/rules", response_model=List[FirewallRule])
async def get_rules(
    action: Optional[str] = Query(None),
    status: Optional[str] = Query(None),
    search: Optional[str] = Query(None)
):
    """Get all firewall rules with optional filters"""
    rules = SAMPLE_RULES.copy()
    
    if action:
        rules = [r for r in rules if r["action"].lower() == action.lower()]
    if status:
        rules = [r for r in rules if r["status"].lower() == status.lower()]
    if search:
        rules = [r for r in rules if search.lower() in r["name"].lower() or search.lower() in r["source"].lower()]
    
    return rules

@app.get("/rules/{rule_id}")
async def get_rule(rule_id: str):
    """Get specific firewall rule"""
    rule = next((r for r in SAMPLE_RULES if r["id"] == rule_id), None)
    if not rule:
        raise HTTPException(status_code=404, detail="Rule not found")
    
    # Add additional details
    rule_details = rule.copy()
    rule_details["details"] = {
        "last_hit": (datetime.now() - timedelta(minutes=random.randint(1, 60))).isoformat(),
        "blocked_ips": random.randint(0, 100),
        "allowed_connections": random.randint(0, 1000),
        "avg_hits_per_hour": random.randint(10, 500)
    }
    
    return rule_details

@app.post("/rules", status_code=201)
async def create_rule(rule: CreateRuleRequest):
    """Create a new firewall rule"""
    new_rule = {
        "id": f"FW-{str(len(SAMPLE_RULES) + 1).zfill(3)}",
        "name": rule.name,
        "source": rule.source,
        "destination": rule.destination,
        "port": rule.port,
        "protocol": rule.protocol,
        "action": rule.action,
        "status": "enabled",
        "priority": rule.priority,
        "hits": 0,
        "created_at": datetime.now().isoformat(),
        "updated_at": datetime.now().isoformat()
    }
    
    SAMPLE_RULES.append(new_rule)
    SAMPLE_RULES.sort(key=lambda x: x["priority"])
    
    return new_rule

@app.put("/rules/{rule_id}")
async def update_rule(rule_id: str, updates: dict):
    """Update a firewall rule"""
    rule = next((r for r in SAMPLE_RULES if r["id"] == rule_id), None)
    if not rule:
        raise HTTPException(status_code=404, detail="Rule not found")
    
    # Update fields
    for key, value in updates.items():
        if key in rule and key not in ["id", "created_at", "hits"]:
            rule[key] = value
    
    rule["updated_at"] = datetime.now().isoformat()
    
    return rule

@app.delete("/rules/{rule_id}")
async def delete_rule(rule_id: str):
    """Delete a firewall rule"""
    global SAMPLE_RULES
    rule = next((r for r in SAMPLE_RULES if r["id"] == rule_id), None)
    if not rule:
        raise HTTPException(status_code=404, detail="Rule not found")
    
    SAMPLE_RULES = [r for r in SAMPLE_RULES if r["id"] != rule_id]
    
    return {
        "status": "success",
        "message": f"Rule {rule_id} deleted successfully",
        "deleted_rule": rule
    }

@app.get("/stats")
async def get_firewall_stats():
    """Get firewall statistics"""
    total_rules = len(SAMPLE_RULES)
    enabled = len([r for r in SAMPLE_RULES if r["status"] == "enabled"])
    disabled = len([r for r in SAMPLE_RULES if r["status"] == "disabled"])
    allow_rules = len([r for r in SAMPLE_RULES if r["action"] == "allow"])
    deny_rules = len([r for r in SAMPLE_RULES if r["action"] == "deny"])
    total_hits = sum(r["hits"] for r in SAMPLE_RULES)
    
    return {
        "total_rules": total_rules,
        "enabled_rules": enabled,
        "disabled_rules": disabled,
        "allow_rules": allow_rules,
        "deny_rules": deny_rules,
        "total_hits": total_hits,
        "blocked_today": random.randint(100, 1000),
        "allowed_today": random.randint(5000, 20000),
        "last_updated": datetime.now().isoformat()
    }

@app.post("/rules/{rule_id}/toggle")
async def toggle_rule(rule_id: str):
    """Toggle rule status (enable/disable)"""
    rule = next((r for r in SAMPLE_RULES if r["id"] == rule_id), None)
    if not rule:
        raise HTTPException(status_code=404, detail="Rule not found")
    
    rule["status"] = "disabled" if rule["status"] == "enabled" else "enabled"
    rule["updated_at"] = datetime.now().isoformat()
    
    return {
        "status": "success",
        "rule_id": rule_id,
        "new_status": rule["status"]
    }

if __name__ == "__main__":
    port = int(os.getenv("PORT", "8084"))
    print(f"üõ°Ô∏è  Firewall Service starting on port {port}")
    uvicorn.run(app, host="0.0.0.0", port=port)

# Updated: 2025-08-08T10:00:00

# Updated: 2025-08-08T13:30:00

# Updated: 2025-08-08T10:00:00

# Updated: 2025-08-08T13:30:00

# Updated: 2025-07-08T10:00:00

# Updated: 2025-07-08T13:30:00

# Updated: 2025-07-25T10:00:00

# Updated: 2025-09-10T09:15:00

# feat(firewall): add firewall service - 2025-07-08

# feat(firewall): implement rule management - 2025-07-08

# feat(firewall): add 15+ firewall rules - 2025-07-25

# feat(firewall): add rule priority system - 2025-09-10

# feat(firewall): add firewall service - 2025-07-08

# feat(firewall): implement rule management - 2025-07-08

# feat(firewall): add 15+ firewall rules - 2025-07-25

# feat(firewall): add rule priority system - 2025-09-10
